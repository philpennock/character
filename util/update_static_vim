#!/bin/sh -eu

# This should not be in shell, should move to go, but for now, be fast to write

generated="sources/generated_static_vim.go"

exec 3>&1
exec 1> "$generated"

echo "// Code generated by util/update_static_vim; DO NOT EDIT."
echo ""
echo "package sources;"
echo
echo "var staticVimData = []byte(\`"

# capture built-in digraphs, so skip any .vimrc additions
# We need to redir from the tty for vim to be happy and emit content;
# `go generate` does not plumb through stdin.
vim -u /dev/null -e +digraphs +quit </dev/tty | \
	perl -pe 's/\e\[[!#>]?[?0-9;]*['"'"'#"*$]?[a-zA-Z^`{|}~]//g;  s/\e=//g; s/\e>//g' | \
	sed 's/`/`+"`"+`/g'

echo '`)'
echo
echo "// EOF"

exec >&3
exec 3>&-

go fmt "$generated"
git add -- "$generated"

echo Done
